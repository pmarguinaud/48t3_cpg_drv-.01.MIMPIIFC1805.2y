#!/bin/bash
#SBATCH -n 10
#SBATCH --mem=20000
#SBATCH -t 01:10:00
#SBATCH -N 1
#SBATCH -p login
if [ "$SLURM_JOB_PARTITION" ] ; then
  export GMKTMP=/dev/shm/$LOGNAME
fi
#
export GMK_THREADS=16
#
type gmkpack >/dev/null 2>&1
if [ $? -ne 0 ] ; then
  echo "error : gmkpack could not be found."
  exit 1
else
  export GMKROOT=$(dirname $(dirname $(which gmkpack | awk '{print $NF}')))
fi
. $GMKROOT/aux/wrkpack.sh
#
# ------ Main settings --------------------------------------
#
# Fortran compiler options :
declare -A optfrt
# optfrt[4] = Optimal, as for operations : -g -O2 -march=core-avx2 -finline-functions -finline-limit=500 -Winline -qopt-prefetch=4 -fast-transcendentals -fimf-use-svml -no-fma
# optfrt[3] = Debugging                  : -g -O0
# optfrt[2] = Debugging + Bound checking : -g -O0 -check bounds
# optfrt[1] = Preinitialisations to NaN  : -init=arrays,snan -fp-stack-check -ftrapuv -fpe0 -fp-speculation=strict -check uninit -check pointers
# optfrt[0] = User-defined options
optfrt[0]=""
#
# Choose subscript (0/1/2/3) :
# --------------------------
Ofrt=4
#
# C compiler options :
optvcc="-g -O2 -march=core-avx2"
#
# CUDA compiler options
optccu=""
#
# Files in pack to ignore (obsolete/useless) :
# ------------------------------------------  
cat > $GMKWRKDIR/.ignored_files <<end_of_ignored_files
end_of_ignored_files
#
# Do you want to compile dependencies ? (yes/no)
# -----------------------------------
export DEP=yes
# If you compile dependencies, approve the following projects list :
export MKPROJECT="aeolus aladin algor arpifs biper blacklist cmake coupling crm ecfftw etrans ifsaux ifsobs mpa mse obstat odb radiation satrad scat surf surfex trans utilities validation"
#
# Supplementary projects with autogenerated explicit interface blocks :
# -------------------------------------------------------------------  
export INTFB_PROJLIST=""
#
# Do you want to enable the recursive update control ? (yes/no) ?
# --------------------------------------------------
export ICS_RECURSIVE_UPDATE=yes
#
# Do you want to postpone the aborts on compilation errors to the end of the compilation step ? (yes/no) ?
# -------------------------------------------------------------------------------------------
export ICS_POSTPONE_ABORT=no
#
# Three compilation modes are possible : 
# full = full compilation (default value)
# incr = incremental compilation (from a starting to an ending level)
# off  = No compilation at all
# Choose compilation mode (full/incr/off) : 
# ---------------------------------------
export ICS_ICFMODE=full
# If you use the incremental compilation facility, select the top and bottom levels :
export ICS_START=
export ICS_STOP=
# Reduced starting list :
cat > $GMKWRKDIR/.reduced_starting_list <<end_of_reduced_starting_list
end_of_reduced_starting_list
#
# Do you want to output the compilation listings ? (yes/no)
# ----------------------------------------------
export ICS_LIST=yes
#
# Compilation timing report:
# ------------------------- 
# ICS_TIMING_REPORT = 0 (No report) = N (N most time consuming files)
export ICS_TIMING_REPORT=0
#
# Norms checker 2011 severity :
# ---------------------------  
# ICS_NC_SEVERITY = 0 (No report) or 1 (Severe,Warning) or 2 (+Informative)
# ICS_NC_SUPPRESS = "section.item:section.item" : suppressed messages
export ICS_NC_SEVERITY=2
export ICS_NC_SUPPRESS=""
export WHITELIST=
export GEN_WHITELIST=0
#
# Do you want to output the load map(s) ? (yes/no)
# -------------------------------------
export ICS_MAP=no
#
# Five libraries update are possible : 
# full  = full update (default value)
# user  = update user libraries only, not the dummy ones
# dummy = update dummy (user-mirror) libraries only, not the user ones
# unsx  = update unsatisfied external libraries only, not the user/dummy ones
# off   = no update at all
# Choose the libraries update mode (full/user/dummy/unsx/off) : 
# --------------------------------
export ICS_UPDLIBS=full
#
#
# ODB Maximum number of updates supported at compile time
odb_nmxupd=4
#
#
# Do you want to make any executable ? (yes/no)
# ----------------------------------
Load=yes
#
# If you want to make any executable, approve the following ones :
# (libraries should be properly ordered from top to bottom for each binary)
#
# Binary "masterodb" :
cat > $GMKWRKDIR/.masterodb_link <<end_of_masterodb_link
EXEC=MASTERODB
ENTRY=arp*/*/master.o
end_of_masterodb_link
# BACKGROUND LIBRARIES (from top to bottom) :
cat > $GMKWRKDIR/.masterodb_libs <<end_of_masterodb_libs
/home/gmap/mrpm/marguina/pack/48t3_cpg_drv+.01.MIMPIIFC1805.2y/lib/libaladin.main.a
/home/gmap/mrpm/marguina/pack/48t3_cpg_drv+.01.MIMPIIFC1805.2y/lib/libarpifs.main.a
/home/gmap/mrpm/marguina/pack/48t3_cpg_drv+.01.MIMPIIFC1805.2y/lib/libradiation.main.a
/home/gmap/mrpm/marguina/pack/48t3_cpg_drv+.01.MIMPIIFC1805.2y/lib/libcrm.main.a
/home/gmap/mrpm/marguina/pack/48t3_cpg_drv+.01.MIMPIIFC1805.2y/lib/libbiper.main.a
/home/gmap/mrpm/marguina/pack/48t3_cpg_drv+.01.MIMPIIFC1805.2y/lib/libcoupling.main.a
/home/gmap/mrpm/marguina/pack/48t3_cpg_drv+.01.MIMPIIFC1805.2y/lib/libetrans.main.a
/home/gmap/mrpm/marguina/pack/48t3_cpg_drv+.01.MIMPIIFC1805.2y/lib/libtrans.main.a
/home/gmap/mrpm/marguina/pack/48t3_cpg_drv+.01.MIMPIIFC1805.2y/lib/libalgor.main.a
/home/gmap/mrpm/marguina/pack/48t3_cpg_drv+.01.MIMPIIFC1805.2y/lib/libifsaux.main.a
/home/gmap/mrpm/marguina/pack/48t3_cpg_drv+.01.MIMPIIFC1805.2y/lib/libmse.main.a
/home/gmap/mrpm/marguina/pack/48t3_cpg_drv+.01.MIMPIIFC1805.2y/lib/libsurfex.main.a
/home/gmap/mrpm/marguina/pack/48t3_cpg_drv+.01.MIMPIIFC1805.2y/lib/libmpa.main.a
/home/gmap/mrpm/marguina/pack/48t3_cpg_drv+.01.MIMPIIFC1805.2y/lib/libodb.main.a
/home/gmap/mrpm/marguina/pack/48t3_cpg_drv+.01.MIMPIIFC1805.2y/lib/libcma-odb.main.a
/home/gmap/mrpm/marguina/pack/48t3_cpg_drv+.01.MIMPIIFC1805.2y/lib/libcountryrst-odb.main.a
/home/gmap/mrpm/marguina/pack/48t3_cpg_drv+.01.MIMPIIFC1805.2y/lib/libmtocomp-odb.main.a
/home/gmap/mrpm/marguina/pack/48t3_cpg_drv+.01.MIMPIIFC1805.2y/lib/libport-odb.main.a
/home/gmap/mrpm/marguina/pack/48t3_cpg_drv+.01.MIMPIIFC1805.2y/lib/librstbias-odb.main.a
/home/gmap/mrpm/marguina/pack/48t3_cpg_drv+.01.MIMPIIFC1805.2y/lib/libsonderst-odb.main.a
/home/gmap/mrpm/marguina/pack/48t3_cpg_drv+.01.MIMPIIFC1805.2y/lib/libsatrad.main.a
/home/gmap/mrpm/marguina/pack/48t3_cpg_drv+.01.MIMPIIFC1805.2y/lib/libsurf.main.a
/home/gmap/mrpm/marguina/pack/48t3_cpg_drv+.01.MIMPIIFC1805.2y/lib/libblacklist.main.a
/home/gmap/mrpm/marguina/pack/48t3_cpg_drv+.01.MIMPIIFC1805.2y/lib/libaeolus.main.a
/home/gmap/mrpm/marguina/pack/48t3_cpg_drv+.01.MIMPIIFC1805.2y/lib/libifsobs.main.a
/home/gmap/mrpm/marguina/pack/48t3_cpg_drv+.01.MIMPIIFC1805.2y/lib/libecfftw.main.a
/home/gmap/mrpm/marguina/pack/48t3_cpg_drv+.01.MIMPIIFC1805.2y/lib/libunsxref-verbose.main.a
end_of_masterodb_libs
# SYSTEM LIBRARIES :
cat > $GMKWRKDIR/.masterodb_sys <<end_of_masterodb_sys
-L/home/gmap/mrpm/khatib/opt/i-2018.5.274/auxlibs/lib -lbufr -lgribex
-L/home/gmap/mrpm/khatib/opt/i-2018.5.274/netcdf-4.7.1/lib -lnetcdff -lnetcdf
-L/home/gmap/mrpm/khatib/opt/i-2018.5.274/eccodes-2.18.1/lib -leccodes_f90 -leccodes
-L/home/gmap/mrpm/khatib/opt/i-2018.5.274/hdf5-1.8.18/lib -lhdf5hl_fortran -lhdf5_fortran -lhdf5
-L/home/gmap/mrpm/khatib/opt/i-2018.5.274/auxlibs/lib -lfdbdummy -lwamdummy -lnaglitedummy -loasisdummy -libmdummy
-Wl,-rpath,/home/gmap/mrpm/khatib/opt/i-2018.5.274/auxlibs/lib
-Wl,-rpath,/home/gmap/mrpm/khatib/opt/i-2018.5.274/netcdf-4.7.1/lib
-Wl,-rpath,/home/gmap/mrpm/khatib/opt/i-2018.5.274/eccodes-2.18.1/lib
-Wl,-rpath,/home/gmap/mrpm/khatib/opt/i-2018.5.274/hdf5-1.8.18/lib
end_of_masterodb_sys
# LOADER AND OPTIONS :
cat > $GMKWRKDIR/.masterodb_load <<end_of_masterodb_load
/home/gmap/mrpm/khatib/public/bin/mimpifc-18.0.5.274 -v -fp-stack-check -qopenmp -qopenmp-threadprivate compat -shared-intel -lrt -lstdc++
end_of_masterodb_load
#
# Libraries in hub : do you want to re-configure even if the build directory exists ? (ON/OFF) : 
# ---------------------------------------------------------------------------------
export GMK_RECONFIGURE=OFF
#
# Libraries in hub : do you want to compile packages ? (ON/OFF) : 
# --------------------------------------------------
export GMK_MAKE=ON
#
# Libraries in hub : do you want to test libraries ? (ON/OFF) : 
# -----------------------------------------------------------
export GMK_TEST=OFF
# Confirm which libraires to test :
export GMK_TEST_LIBRARIES_IN_ecSDK="ecbuild eckit fckit"
export GMK_TEST_LIBRARIES_IN_OOPS="oops_src"
export GMK_TEST_LIBRARIES_IN_Atlas="atlas"
export GMK_TEST_LIBRARIES_IN_Fiat="fiat"
export GMK_TEST_LIBRARIES_IN_Ectrans="ectrans"
#
# Libraries in hub : do you want to install packages ? (ON/OFF) : 
# --------------------------------------------------
export GMK_INSTALL=ON
#
#
# Blacklist file generator
# ------------------------

export ICS_BL_GENERATOR=


# Verboose level (0 or 1 or 2 or 3) :
# --------------

export ICS_ECHO=1

export GMKVIEW="main local"
export TARGET_PACK=/home/gmap/mrpm/marguina/pack/48t3_cpg_drv+.01.MIMPIIFC1805.2y
# ----------------------------------------------------------------------------------
# ----------------------------------------------------------------------------------
#
#
# ------ Environment variables -----------------------------------------------------
#
$GMKROOT/aux/envvarpack.sh > $GMKWRKDIR/environment_variables
if [ $? -eq 0 ] ; then
  chmod 755 $GMKWRKDIR/environment_variables
  . $GMKWRKDIR/environment_variables
  \rm $GMKWRKDIR/environment_variables 
else
  echo "Error in envvarpack.sh :"
  cat $GMKWRKDIR/gmkpack_env_variables
  \rm -rf $GMKWRKDIR
  exit 1
fi
#
#
# IF YOU WISH TO CHANGE OR ADD ANY VARIABLE FROM THE CONFIGURATION FILE
# YOU SHOULD DO IT RIGHT BELOW THIS LINE !
#
#
#
$GMKROOT/aux/privarpack.sh > $GMKWRKDIR/environment_variables
chmod 755 $GMKWRKDIR/environment_variables
. $GMKWRKDIR/environment_variables
\rm $GMKWRKDIR/environment_variables
optfrt[4]="$OPT_FRTFLAGS" 
optfrt[3]="$DBG_FRTFLAGS"
optfrt[2]="$DBG_FRTFLAGS $BCD_FRTFLAGS"
optfrt[1]="$OPT_FRTFLAGS $NAN_FRTFLAGS"
export MyF90Flags="${optfrt[$Ofrt]}"
export MyF77Flags="${optfrt[$Ofrt]}"
export MyVccFlags="$optvcc"
export MyCcuFlags="$optccu"
#
export ODB_NMXUPD=$odb_nmxupd
#
echo
echo "This is $(basename $(grep ^THIS_GMKPACK $GMKROOT/util/gmkpack | awk -F"/" '{print $(NF-2)}')) running on a script made by gmkpack.6.9.2"

echo
$GMKROOT/aux/catenvpack.sh
#
# Compilation :
# -----------
$GMKROOT/aux/mkcplpack.sh
if [ $? -ne 0 ] ; then
  echo
  echo Finished on $(date)
  exit 1
fi
#
# Libraries :
# ---------
$GMKROOT/aux/libspack.sh
if [ $? -ne 0 ] ; then
  echo
  echo Finished on $(date)
  exit 1
fi
#
# Binaries :
# --------
if [ "$Load" = "yes" ] ; then
  $GMKROOT/aux/lnkpack.sh
  exit_code=$?
else
  exit_code=0
fi
echo
\rm -rf $GMKWRKDIR
echo Finished on $(date)
exit $exit_code
