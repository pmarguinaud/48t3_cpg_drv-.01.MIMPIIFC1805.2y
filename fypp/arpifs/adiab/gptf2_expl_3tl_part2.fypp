#:set config_file = os.path.dirname(_THIS_FILE_) + '/../module/field_config.yaml'
#:set config = field_config.VariableConfiguration(config_file)
#:set gfl = config.groups['GFL']

SUBROUTINE GPTF2_EXPL_3TL_PART2 (YDGEOMETRY, YDDYN, KST, KEN, LDFSTEP, YDVARS)

USE PARKIND1, ONLY : JPIM, JPRB
USE YOMHOOK,  ONLY: LHOOK, DR_HOOK

USE GEOMETRY_MOD , ONLY : GEOMETRY
USE MODEL_GENERAL_CONF_MOD , ONLY : MODEL_GENERAL_CONF_TYPE
USE FIELD_VARIABLES_MOD    , ONLY : FIELD_VARIABLES
USE YOMDYN       , ONLY : TDYN


IMPLICIT NONE

TYPE(GEOMETRY)    ,INTENT(IN)    :: YDGEOMETRY
TYPE(TDYN)        ,INTENT(IN)    :: YDDYN
INTEGER(KIND=JPIM),INTENT(IN)    :: KST
INTEGER(KIND=JPIM),INTENT(IN)    :: KEN
LOGICAL           ,INTENT(IN)    :: LDFSTEP
TYPE(FIELD_VARIABLES),INTENT(INOUT) :: YDVARS

INTEGER (KIND=JPIM) :: JLEV, JFLD, JLON

REAL(KIND=JPRB) :: ZHOOK_HANDLE

IF (LHOOK) CALL DR_HOOK("GPTF2_EXPL_3TL_PART2",0,ZHOOK_HANDLE)

IF (LDFSTEP) THEN

#:for v in gfl.variables
#:if v.array == 1
  DO JFLD = 1, SIZE (YDVARS%${v.name}$)
    CALL GPTF2_EXPL_3TL_PART2_FSTEP_T (YDVARS%${v.name}$(JFLD)%LT9, YDVARS%${v.name}$(JFLD)%T9, YDVARS%${v.name}$(JFLD)%T0)
  ENDDO
#:else
  CALL GPTF2_EXPL_3TL_PART2_FSTEP_T (YDVARS%${v.name}$%LT9, YDVARS%${v.name}$%T9, YDVARS%${v.name}$%T0)
#:endif
#:endfor

ELSE

#:for v in gfl.variables
#:if v.array == 1
#:else
  CALL GPTF2_EXPL_3TL_PART2_FSTEP_F (YDVARS%${v.name}$%LT9, YDVARS%${v.name}$%T9, YDVARS%${v.name}$%T0)
#:endif
#:endfor

ENDIF

IF (LHOOK) CALL DR_HOOK("GPTF2_EXPL_3TL_PART2",1,ZHOOK_HANDLE)

CONTAINS 

SUBROUTINE GPTF2_EXPL_3TL_PART2_FSTEP_T (LDT9, PT9, PT0)

LOGICAL, INTENT (IN) :: LDT9
REAL (KIND=JPRB), INTENT (INOUT) :: PT9 (YDGEOMETRY%YRDIM%NPROMA,YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN)    :: PT0 (YDGEOMETRY%YRDIM%NPROMA,YDGEOMETRY%YRDIMV%NFLEVG)

IF (LDT9) THEN
  DO JLEV=1,YDGEOMETRY%YRDIMV%NFLEVG
    DO JLON=KST,KEN
      PT9 (JLON,JLEV) = PT0 (JLON,JLEV)
    ENDDO
  ENDDO
ENDIF

END SUBROUTINE GPTF2_EXPL_3TL_PART2_FSTEP_T

SUBROUTINE GPTF2_EXPL_3TL_PART2_FSTEP_F (LDT9, PT9, PT0)

LOGICAL, INTENT (IN) :: LDT9
REAL (KIND=JPRB), INTENT (INOUT) :: PT9 (YDGEOMETRY%YRDIM%NPROMA,YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN)    :: PT0 (YDGEOMETRY%YRDIM%NPROMA,YDGEOMETRY%YRDIMV%NFLEVG)

IF (LDT9) THEN
  DO JLEV=1,YDGEOMETRY%YRDIMV%NFLEVG
    DO JLON=KST,KEN
      PT9 (JLON,JLEV) = PT9 (JLON,JLEV) + YDDYN%REPSM2 * PT0 (JLON,JLEV)
    ENDDO
  ENDDO
ENDIF


END SUBROUTINE GPTF2_EXPL_3TL_PART2_FSTEP_F

END SUBROUTINE
